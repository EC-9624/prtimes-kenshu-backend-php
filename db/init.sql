CREATE TABLE "users" (
  "user_id" uuid PRIMARY KEY,
  "user_name" varchar(255) UNIQUE NOT NULL,
  "email" varchar(255) UNIQUE,
  "password" varchar(255) NOT NULL,
  "created_at" timestamp NOT NULL DEFAULT (now()),
  "updated_at" timestamp DEFAULT NULL
);

CREATE TABLE "posts" (
  "post_id" uuid PRIMARY KEY,
  "user_id" uuid,
  "title" varchar(255) NOT NULL,
  "slug" varchar(255) UNIQUE NOT NULL,
  "text" text NOT NULL,
  "thumbnail_image_id" uuid,
  "created_at" timestamp NOT NULL DEFAULT (now()),
  "updated_at" timestamp DEFAULT null,
  "deleted_at" timestamp DEFAULT null
);

CREATE TABLE "tags" (
  "tag_id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "name" varchar(255) NOT NULL,
  "slug" varchar(255) UNIQUE NOT NULL,
  "created_at" timestamp NOT NULL DEFAULT (now())
);

CREATE TABLE post_tags (
  post_id uuid,
  tag_id int,
  created_at timestamp NOT NULL DEFAULT (now()),
  PRIMARY KEY (post_id, tag_id)
);

CREATE TABLE "images" (
  "image_id" uuid PRIMARY KEY,
  "post_id" uuid,
  "image_path" varchar(255),
  "alt_text" varchar(255),
  "created_at" timestamp NOT NULL DEFAULT (now())
);

COMMENT ON COLUMN "users"."password" IS 'hashed value';
COMMENT ON COLUMN "posts"."deleted_at" IS 'soft delete';

-- foreign keys
ALTER TABLE "posts" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("user_id");

ALTER TABLE "posts"
ADD CONSTRAINT posts_thumbnail_image_id_fkey
FOREIGN KEY ("thumbnail_image_id") REFERENCES "images" ("image_id")
ON DELETE SET NULL;

ALTER TABLE "post_tags" ADD FOREIGN KEY ("post_id") REFERENCES "posts" ("post_id");
ALTER TABLE "post_tags" ADD FOREIGN KEY ("tag_id") REFERENCES "tags" ("tag_id");
ALTER TABLE "images" ADD FOREIGN KEY ("post_id") REFERENCES "posts" ("post_id") ON DELETE CASCADE;

-- indexes

-- Index on the foreign key in the posts table
CREATE INDEX idx_posts_user_id ON posts (user_id);
CREATE INDEX idx_posts_thumbnail_image_id ON posts (thumbnail_image_id);
--Index for search
CREATE INDEX idx_posts_slug ON posts (slug);

-- Index on the foreign key in the post_tags table (for queries filtering only by tag_id)
CREATE INDEX idx_post_tags_tag_id ON post_tags (tag_id);

-- Index on the foreign key in the images table
CREATE INDEX idx_images_post_id ON images (post_id);
